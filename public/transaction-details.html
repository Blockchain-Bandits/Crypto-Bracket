<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="assets/vendor/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="assets/vendor/font-awesome/css/font-awesome.min.css">
    <!-- Custom icon font-->
    <link rel="stylesheet" href="assets/css/fontastic.css">
    <!-- Google fonts - Roboto -->
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
    <!-- jQuery Circle-->
    <link rel="stylesheet" href="assets/css/grasp_mobile_progress_circle-1.0.0.min.css">
    <!-- Custom Scrollbar-->
    <link rel="stylesheet" href="assets/vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">
    <!-- theme stylesheet-->
    <link rel="stylesheet" href="assets/css/style.blue.css" id="theme-stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="assets/css/custom.css">
    <!-- Favicon-->
    <link rel="shortcut icon" href="assets/img/favicon.ico">
    <!-- Tweaks for older IEs-->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <title>Transactions Page</title>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <form id="select-form" class="form-inline my-2 my-lg-0">
                    <select id="select-coin" class="form-control">
                        <option selected>Select Coin</option>
                    </select>
                    <select id="select-method" class="form-control">
                        <option selected>Select Method</option>
                        <option value="fifo">FIFO</option>
                        <option value="lifo">LIFO</option>
                        <option value="avg">Average Cost</option>
                    </select>
                    <button class="btn" type="submit">Go</button>
                </form>
                <!-- Current Tables in Use -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">Transactions</h4>
                    </div>
                    <div class="panel-body" id="tableSection">
                        <table class="table">
                            <thead>
                                <tr id="table-headers">
                                    <th>Date</th>
                                    <th>Cost</th>
                                    <th>Price</th>
                                    <th>Units</th>
                                    <th>Total</th>
                                    <th>Unit Gain/(Loss)</th>
                                    <th>Batch Gain/(Loss)</th>
                                    <th>% Gain/(Loss)</th>
                                </tr>
                            </thead>
                            <tbody id="transactions">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    // Get the location of the root page.
    var currentURL = window.location.origin;

    $.ajax({ url: currentURL + "/api/transactions", method: "GET" })
    .done(function(tableData) {

        // Here we then log the data to console, where it will show up as an object.
        console.log(tableData);
        console.log("------------------------------------");

        // Loop through and display each of the customers
        for (var i = 0; i < tableData.length; i++) {
            $("#select-coin").append("<option value='" + tableData[i].coin + "'>" + tableData[i].coin + "</option>");
        }
    });

    function runTableQuery(coin, method) {
        $("#transactions").empty();
        
        // The AJAX function uses the URL of our API to GET the data associated with it (initially set to localhost)
        $.ajax({ url: currentURL + `/api/transactions/${coin}/${method}`, method: "GET" })
        .done(function(tableData) {

            // Here we then log the data to console, where it will show up as an object.
            console.log(tableData);
            
            var length = tableData.length - 1;
            // Loop through and display each of the customers
            for (var i = 0; i < length; i++) {
                var unitDiff = tableData[length].currentPrice - tableData[i].cost;
                var totalDiff = unitDiff * tableData[i].units;
                var percent = tableData[i].units < 0 ? "" : ((tableData[i].total_cost + totalDiff) / tableData[i].total_cost) * 100;
                $("#transactions").append("<tr><td>" + tableData[i].date +
                    "</td><td>$" + tableData[i].cost.toFixed(2) +
                    "</td><td>$" + tableData[i].price.toFixed(2) +
                    "</td><td>$" + tableData[i].units.toFixed(2) +
                    "</td><td>$" + tableData[i].total_cost.toFixed(2) +
                    "</td><td>$" + unitDiff.toFixed(2) +
                    "</td><td>$" + totalDiff.toFixed(2) +
                    "</td><td>" + percent.toFixed(2) + "%</td></tr>"
                );
            }
        });
    }

    $("#select-form").on("submit", function() {
        event.preventDefault();
        var coin = $("#select-coin").val();
        var method = $("#select-method").val();
        runTableQuery(coin, method);
    });

$("#select-coin").on("change", function() {
    runTableQuery($(this).val());
});
</script>

</html>