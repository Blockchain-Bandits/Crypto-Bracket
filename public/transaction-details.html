<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transactions Page</title>

    <!-- Latest compiled and minified CSS & JS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

</head>
<body>

    <div class="container">

        <div class="row">
            <div class="col-lg-12">
                <form id="select-form" class="form-inline my-2 my-lg-0">
                    <select id="select-coin" class="form-control">
                        <option selected>Select Coin</option>
                    </select>
                    <select id="select-method" class="form-control">
                        <option selected>Select Method</option>
                        <option value="fifo">FIFO</option>
                        <option value="lifo">LIFO</option>
                        <option value="avg">Average Cost</option>
                    </select>
                    <button class="btn" type="submit">Go</button>
                </form>

                <!-- Current Tables in Use -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">Transactions</h4>
                    </div>
                    <div class="panel-body" id="tableSection">
                        <table class="table">
                            <thead>
                                <tr id="table-headers">
                                    <th>Date</th>
                                    <th>Cost</th>
                                    <th>Price</th>
                                    <th>Units</th>
                                    <th>Total</th>
                                    <th>Unit Gain/(Loss)</th>
                                    <th>Batch Gain/(Loss)</th>
                                    <th>% Gain/(Loss)</th>
                                </tr>
                            </thead>
                            <tbody id="transactions">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

</body>

<script type="text/javascript">
    // Get the location of the root page.
    var currentURL = window.location.origin;

    $.ajax({ url: currentURL + "/api/transactions", method: "GET" })
    .done(function(tableData) {

        // Here we then log the data to console, where it will show up as an object.
        console.log(tableData);
        console.log("------------------------------------");

        // Loop through and display each of the customers
        for (var i = 0; i < tableData.length; i++) {
            $("#select-coin").append("<option value='" + tableData[i].coin + "'>" + tableData[i].coin + "</option>");
        }
    });

    function runTableQuery(coin, method) {
        $("#transactions").empty();
        
        // The AJAX function uses the URL of our API to GET the data associated with it (initially set to localhost)
        $.ajax({ url: currentURL + `/api/transactions/${coin}/${method}`, method: "GET" })
        .done(function(tableData) {

            // Here we then log the data to console, where it will show up as an object.
            console.log(tableData);
            
            var length = tableData.length - 1;
            // Loop through and display each of the customers
            for (var i = 0; i < length; i++) {
                var unitDiff = tableData[length].currentPrice - tableData[i].cost;
                var totalDiff = unitDiff * tableData[i].units;
                var percent = tableData[i].units < 0 ? "" : ((tableData[i].total_cost + totalDiff) / tableData[i].total_cost) * 100;
                $("#transactions").append("<tr><td>" + tableData[i].date +
                    "</td><td>$" + tableData[i].cost.toFixed(2) +
                    "</td><td>$" + tableData[i].price.toFixed(2) +
                    "</td><td>$" + tableData[i].units.toFixed(2) +
                    "</td><td>$" + tableData[i].total_cost.toFixed(2) +
                    "</td><td>$" + unitDiff.toFixed(2) +
                    "</td><td>$" + totalDiff.toFixed(2) +
                    "</td><td>" + percent.toFixed(2) + "%</td></tr>"
                );
            }
        });
    }

    $("#select-form").on("submit", function() {
        event.preventDefault();
        var coin = $("#select-coin").val();
        var method = $("#select-method").val();
        runTableQuery(coin, method);
    });

</script>
</html>
